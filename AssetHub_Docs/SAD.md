# 技术架构 (LZG)

本章节仅描述**技术架构要求与应达到的效果**，不绑定具体产品/中间件/框架选型；实现时可在满足约束的前提下替换组件与落地方式。

## 1. 架构目标（需要达到的效果）

1. **统一界面入口（一个系统体验）**：用户视角下，所有功能模块应表现为“一个系统”，实现统一入口、统一导航、统一身份、统一主题/语言与一致交互反馈；模块间切换应尽量无割裂。
2. **统一资产主数据**：所有上层应用（EMS、未来 OEE/环保/维保等）对“设备/位置/关系/测点绑定/资产属性”使用同一套权威数据源与 API，避免重复建模与数据孤岛。
3. **动静结合**：静态主数据（台账、结构、属性）与动态数据（测点、事件、时序指标、工单/告警等）可在同一业务上下文中被关联、查询与分析，并可按资产/位置回溯。
4. **配置/插件驱动扩展**：新行业能力通过“启用插件 + 配置”上线，尽量减少定制开发；插件具备可复用、可部署、可隔离与可治理特性（启用/停用/升级/回滚）。
5. **多维指标体系**：支持按任意业务维度（楼层/产线/设备类型/状态/自定义标签等）进行过滤、分组、下钻、趋势对比；维度扩展可配置且口径一致。
6. **国产化与内网部署友好**：支持纯内网、离线/弱网、国产软硬件环境；外部依赖可替换且不形成强绑定。
7. **可观测、可运维、可演进**：链路追踪、审计、备份恢复、滚动升级、数据保留与归档策略具备可操作性；支持分阶段演进与平滑迁移。

---

## 2. 分层与模块边界（逻辑架构要求）

平台逻辑上应至少拆分为以下层次，各层通过明确契约解耦；禁止跨层直接耦合底层存储或内部实现细节。

### 2.1 统一界面入口（统一工作台/门户）

- 作为唯一用户入口，负责全局导航、路由、身份、权限、主题、多语言、消息中心与全局交互规范治理；自身不承载具体行业业务逻辑。
- 支持模块化集成与独立交付，各业务模块可独立演进、独立部署；入口在运行时按配置启用/禁用与装配。
- 页面与导航支持配置驱动，可在不整体发布的前提下调整信息架构与模块可见性（受权限控制）。
- 提供跨模块一致的交互体验（加载/错误/成功提示、表单规范、通知与待办呈现等），降低学习成本。
- 对关键协同能力（模块清单、导航树、页面编排、用户与权限、主题与多语言等）定义稳定契约，并具备版本管理与兼容策略。

### 2.2 统一数据接入层（Adapters）

- 支持从 WAGO SCADA、iDM、IoT 网关以及第三方系统（ERP/MES/CMMS 等）接入数据。
- 接入层负责规范化事件结构、鉴权、限流、幂等与基础校验，形成可复用的接入治理能力。

### 2.3 事件/消息骨干（Event Backbone）

- 解耦生产者与消费者；支持至少一次投递；支持回放（replay）与按时间范围重放。
- 需支持对事件的全链路追踪（来源、处理状态、失败原因、重试/回放记录），并可用于问题定位与运维操作。
- 事件需包含租户标识、幂等键、业务时间、接入时间、来源标识、事件类型/版本等元信息。

### 2.4 规则与指标计算层（Rules & KPI Engine）

- 支持声明式规则/指标定义（来自行业插件配置），并具备运行时解释执行能力。
- 至少覆盖两类典型计算：
  - 采样型累计量 → 支持差分/增量计算与状态管理（含故障恢复）
  - 事件型计数 → 支持窗口聚合与“空窗口补零”
- 支持乱序/迟到数据处理策略（可配置容忍窗口/水位线等）。
- 支持回补（backfill）与重算（recompute），确保规则变更后可再生历史指标并可追溯依据。

### 2.5 维度打标/语义关联层（Tagging & Context Enrichment）

- 从统一资产模型提取维度（位置层级、资产类型、组织、标签、上下游关系等），注入到派生指标的维度标签中。
- 高频读取需支持缓存与失效策略；维度变更后应可触发增量更新/重打标。

### 2.6 存储层（按职责分库/分域，不限定实现）

- 关系型主数据存储（强一致）：资产类型、资产实例、子模型、测点元数据、插件注册信息、权限与审计等。
- 时序/指标存储（高写入高压缩）：统一指标模型，支持按时间与标签检索、聚合、降采样与保留策略。
- （可选）关系/拓扑增强：用于多跳关系、影响分析、根因路径、血缘追踪等；不用于大规模时序聚合。
- （可选）离线分析/报表增强：用于大规模离线统计、宽表分析与高并发报表。

### 2.7 统一查询与开放接口层（API）

- 对外提供统一的资产 API、指标查询 API、规则/插件管理 API，以及可选的标准兼容接口。
- API 版本化（v1/v2 等）、接口文档与契约测试机制可落地；支持面向服务间调用的统一鉴权与审计。

### 2.8工作流引擎

- 支持行业特定的业务流程模板，包含：流程步骤、角色权限、审批规则、触发条件
- 支持流程的可视化配置与版本管理

### 2.9 多租户与数据隔离

- 多租户实现模型（物理隔离 vs 逻辑隔离）
- 安全边界：跨租户访问审计、租户管理员权限模型、合规隔离（例如为监管客户提供物理隔离）

### 2.10 边缘/离线/弱网支持

- 双向同步策略（Delta sync），冲突解决规则，能在边缘执行规则、做本地缓存、离线告警并在连通时回传

### 2.11 模型/ML 能力

- 模型生命周期管理（Model Registry）：模型版本、训练数据快照、评估指标、审批流与回滚。
- 可解释性与合规：决策链审计，方便运维/合规排查。

---

## 3. 统一资产模型（主数据）能力要求

平台需支持：

1. **固定核心结构 + 扩展字段机制**
    - 平台需要面向不同行业与设备类型（例如电表、粮机、以及未来新增行业设备）进行资产建模。这些资产既存在一部分**共享字段**（如编码、名称、位置、状态、归属等），也存在大量**类型特有字段**（如不同设备需追踪的技术参数、铭牌信息、运行约束、验收口径等）。因此需要在**不改变存储机制与接口语义稳定性**的前提下，实现“同一套资产体系可持续扩展字段”的能力。
    - **例如**：
        - 资产类型模板（Asset Type）用于定义该类型资产的字段元数据（schema），包括字段标识、名称、数据类型、单位/枚举、必填/默认值、校验规则、是否可检索/可聚合、展示分组等。
        - 资产实例（Asset Instance）存放固定核心字段与扩展字段值（properties），并可依据“资产类型模板”进行字段校验与一致性约束。
    - 扩展字段机制应避免通过频繁结构变更来适配新类型字段，从而降低升级与运维风险；同时应支持按需建立索引/检索能力，确保在常用查询场景下具备可控的性能与成本。

2. **子模型（Submodel）挂载**
	- 同一资产可挂载多个子模型（维保、能效、健康、巡检等），子模型亦支持扩展属性与模板化。
	- 效果：核心资产稳定，业务能力按需叠加，降低模块耦合。

3. **测点绑定（Measurement Point）**
	- 将测点与资产建立绑定关系（测点标识 → asset_id + metric_name + unit + data_type 等）。
	- 支持批量导入、校验、继承/模板化绑定，以及（可选）插件提供绑定建议。

4. **多维关系表达**
	- 支持树形层级与多对多网状关系（供电关系、工艺关系、网络关系等）。
	- 对多归属/多跳复杂关系，需提供可选增强能力，避免关系查询复杂度失控。

---

## 4. 行业插件机制（平台级要求）

插件是“可复用、可部署、可隔离的行业解决方案包”，平台需要提供：

1. **插件包规范与注册**
	- 插件包含元数据（名称/版本/依赖/兼容性）、资产类型/子模型、KPI 定义、规则、看板/页面配置（以及可选扩展能力声明）。
	- 插件可启用/禁用、版本升级/回滚、依赖校验、冲突检测（同名 key、字段名冲突、指标冲突等）。

2. **声明式优先，扩展受控**
	- 大多数场景通过声明式配置落地；复杂逻辑允许可选扩展，但必须具备隔离与安全边界（资源限制、权限、审计）。

3. **运行时生效与最小化中断**
	- 插件加载后应自动注册资产类型、规则、看板菜单/页面配置等；不应要求整个平台长时间中断（如需中断需提供最小化窗口与回滚策略）。
	- 插件沙箱/资源配额：CPU/内存/磁盘/网络配额；插件运行在受控环境（容器/namespace）内以避免互相影响。

4. **可观测与可审计**
	- 插件引入的规则/指标计算需可追溯来源（插件版本、规则 ID、配置快照、计算版本等）。

---

## 5. 指标体系与时序数据（统一 Metrics）要求

1. **统一指标模型**
	- 指标写入遵循统一命名与标签规范，必须包含租户/项目边界信息。
	- 控制标签基数（禁止高基数随机维度直接作为标签），提供治理规则与告警/拦截机制。

2. **典型计算能力（必须）**
	- 累计差分：支持每 key 状态管理与故障恢复
	- 事件计数：窗口聚合 + 空窗口补零
	- 常用聚合：sum/avg/max/min/last/rate 等（按配置启用与组合）

3. **保留与归档**
	- 标签基数治理机制：禁止/告警高基数标签的产生；提供 tag mapping、tag cardinality limit、标签替代（如把随机维度做为字段而非标签）
	- 支持热/冷数据分层、降采样策略、保留周期可配置；历史回放与重算不依赖在线热数据永久保留。

---

## 6. 关键协同契约（前后端衔接点，必须标准化）

为实现“统一界面入口”的一致体验，至少需要标准化以下契约（均需版本化与向后兼容策略）：

- 用户与权限：用户信息、租户/项目边界、权限集/能力清单、审计要求
- 模块清单：模块启用状态、可见范围、入口/依赖信息（不绑定具体集成技术）
- 导航与页面编排：菜单树、页面定义、组件/区域编排配置、权限过滤结果
- 主题与多语言：主题变量/资源、语言包资源、按需加载与可覆盖策略
- 通知与待办（可选）：跨模块消息聚合、已读/未读与处理状态同步

---

## 7. 非功能性要求（SLA/SLO 可在项目阶段量化）

- 安全：租户隔离、最小权限、敏感信息保护、关键操作审计、可配置安全策略
- 可靠性：关键链路可降级与可恢复；一致性校验与异常补偿机制可落地
- 性能：高频写入与高并发查询可扩展；热点维度与常用查询具备优化空间
- 可运维：健康检查、告警、容量与成本可视化、可演练的备份恢复能力
- 可演进：数据模型、规则与接口支持版本化；提供迁移/兼容策略，避免升级“全量改造”

