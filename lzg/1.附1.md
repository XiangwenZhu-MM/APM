# 📎 附件1：统一资产模型设计  
## ——完整技术备忘录（含电表/粮机示例与 AAS 映射）

> 本备忘录整合了统一资产模型的核心设计、多维拓扑建模、业务扩展能力（维保/巡检/备件）、SCADA 测点集成、多维统计支撑，以及面向 IEC 63278（AAS）标准的映射机制，并通过 **电表** 与 **粮机** 两个典型工业场景进行完整示例说明。

---

## 一、核心数据模型（ER 结构）

### 1. 核心实体关系图（ERD）

```plaintext
+-------------------+          +---------------------+
|    asset_type     |          |   submodel_template |
+-------------------+          +---------------------+
| id (PK)           |<---------| id (PK)             |
| key               |          | name                |
| name              |          | semantic_id         |
| plugin_id         |          | properties_schema   |
| schema_json       |          +---------------------+
| created_at        |
+-------------------+

+-------------------+          +---------------------+
|  asset_instance   |          |  asset_submodel     |
+-------------------+          +---------------------+
| id (PK)           |<---------| id (PK)             |
| asset_type_id (FK)|          | asset_id (FK)       |
| name              |          | submodel_name       |
| location_path     |          | properties (JSONB)  |
| status            |          | created_at          |
| properties (JSONB)|          +---------------------+
| created_at        |
+-------------------+

+-------------------+          +---------------------+
| measurement_point |          |      aas_mapping    |
+-------------------+          +---------------------+
| tag (PK)          |          | aas_id (PK)         |
| asset_id (FK)     |          | asset_id (FK)       |
| metric_name       |          | submodel_id (FK)    |
| unit              |          | property_mapping    |
| data_type         |          +---------------------+
| is_energy_related |
+-------------------+

+---------------------------+    +------------------------+
| power_supply_relation     |    | inspection_item_       |
+---------------------------+    | template               |
| meter_asset_id (FK)       |    +------------------------+
| equipment_asset_id (FK)   |    | asset_type_key         |
+---------------------------+    | item_name              |
                                 | frequency_days         |
+------------------+    +---------------------+           +----------------------+
| spare_part       |----| asset_spare_part    |           | asset_inspection_item|
+------------------+    +---------------------+           +----------------------+
```

---

## 二、关键表结构与存储逻辑

### 1. `asset_type` —— 设备类型模板（由插件定义）

```sql
CREATE TABLE asset_type (
    id UUID PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,          -- 如 'electric_meter', 'grain_machinery'
    name TEXT NOT NULL,
    plugin_id TEXT,
    schema_json JSONB NOT NULL,        -- 字段元数据
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 示例：粮机插件 YAML 定义（`grain_machinery.type.yaml`）
```yaml
key: grain_machinery
name: 粮食加工设备
fields:
  - name: equipmentCode
    label: 设备编码
    type: string
    required: true
  - name: processStage
    label: 工艺阶段
    type: enum
    options: [cleaning, drying, milling, packaging]
  - name: manufacturer
    label: 制造商
    type: string
  - name: installFloor
    label: 安装楼层
    type: string   # 如 "3F"
```

→ 此 YAML 被解析后写入 `asset_type.schema_json`。

---

### 2. `asset_instance` —— 设备实例（运行时数据）

```sql
CREATE TABLE asset_instance (
    id UUID PRIMARY KEY,
    asset_type_id UUID NOT NULL REFERENCES asset_type(id),
    name TEXT NOT NULL,
    location_path TEXT,                -- 树形拓扑路径
    status TEXT DEFAULT 'active',
    properties JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 示例 1：电表实例
| 字段 | 值 |
|------|----|
| `name` | "主进线柜电表" |
| `location_path` | `"PlantA/PowerRoom/MainIncoming/Meter01"` |
| `properties` | `{"meterId": "EM-2025-001", "circuitType": "main_incoming", "ratedVoltage": 380}` |

> ✅ `location_path` 编码了安装拓扑：工厂 → 配电室 → 主进线柜 → 电表

#### 示例 2：粮机实例
| 字段 | 值 |
|------|----|
| `name` | "3号烘干塔" |
| `location_path` | `"GrainPlant/DryingWorkshop/Line2/Tower03"` |
| `properties` | `{"equipmentCode": "GT-303", "processStage": "drying", "installFloor": "3F", "manufacturer": "ABC Machinery"}` |

> ✅ `location_path` 表达：厂区 → 车间 → 产线 → 设备  
> ✅ `properties.installFloor` 提供跨车间的楼层维度

---

### 3. 多维关系拓扑建模

#### （1）树形拓扑：`location_path`
- 用于表达物理安装层级（如：工厂/车间/产线/设备）
- 支持高效层级查询与聚合：
  ```sql
  SELECT * FROM asset_instance 
  WHERE location_path LIKE 'GrainPlant/DryingWorkshop/%';
  ```

#### （2）网状拓扑：自定义关系表（非父子关系）

例如：一台电表为多个粮机供电（多对多）

```sql
CREATE TABLE power_supply_relation (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    meter_asset_id UUID NOT NULL REFERENCES asset_instance(id),
    equipment_asset_id UUID NOT NULL REFERENCES asset_instance(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (meter_asset_id, equipment_asset_id)
);
```

> 📌 支持：
> - 查询“某电表下所有负载设备”
> - 反向追溯“某粮机由哪块电表计量”

---

### 4. 业务扩展：通过 Submodel 挂载

#### `asset_submodel` 表

```sql
CREATE TABLE asset_submodel (
    id UUID PRIMARY KEY,
    asset_id UUID NOT NULL REFERENCES asset_instance(id),
    submodel_name TEXT NOT NULL,       -- 如 'maintenance', 'energy'
    properties JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 示例：维保子模型（`maintenance.submodel.yaml`）
```yaml
name: maintenance
properties:
  - name: nextInspectionDate
    type: date
  - name: lastMaintenanceDate
    type: date
  - name: maintenanceCycleDays
    type: number
```

→ 存入 `asset_submodel`：

| asset_id | submodel_name | properties |
|---------|--------------|-----------|
| [Tower03 ID] | maintenance | `{"nextInspectionDate": "2026-03-01", "maintenanceCycleDays": 90}` |

---

### 5. 巡检项关联机制

```sql
-- 巡检项模板（由插件预置）
CREATE TABLE inspection_item_template (
    id UUID PRIMARY KEY,
    asset_type_key TEXT NOT NULL,      -- 如 'grain_machinery'
    item_name TEXT NOT NULL,           -- 如 '轴承温度检查'
    check_method TEXT,                 -- 目视/测温枪
    frequency_days INT
);

-- 设备-巡检项实例（可动态调整）
CREATE TABLE asset_inspection_item (
    id UUID PRIMARY KEY,
    asset_id UUID NOT NULL REFERENCES asset_instance(id),
    template_id UUID NOT NULL REFERENCES inspection_item_template(id),
    is_active BOOLEAN DEFAULT true
);
```

> ✅ 新增粮机设备时，自动继承“粮机类巡检项”，也可手动增删。

---

### 6. 备件与库存管理

```sql
-- 备件主数据（可来自 ERP 同步）
CREATE TABLE spare_part (
    id UUID PRIMARY KEY,
    part_code TEXT UNIQUE,
    name TEXT,
    spec TEXT
);

-- 设备-备件关联（该设备常用备件）
CREATE TABLE asset_spare_part (
    asset_id UUID REFERENCES asset_instance(id),
    spare_part_id UUID REFERENCES spare_part(id),
    recommended_qty INT,  -- 建议库存
    PRIMARY KEY (asset_id, spare_part_id)
);

-- 工单消耗记录（维修时扣减）
CREATE TABLE work_order_spare_usage (
    work_order_id UUID,
    spare_part_id UUID,
    used_qty INT
);
```

> 💡 当创建“烘干塔维修工单”时，系统自动提示所需备件及当前库存。

---

### 7. 测点绑定：连接 SCADA

```sql
CREATE TABLE measurement_point (
    tag TEXT PRIMARY KEY,              -- SCADA 测点标识
    asset_id UUID NOT NULL REFERENCES asset_instance(id),
    metric_name TEXT NOT NULL,         -- 如 'active_power', 'soc'
    unit TEXT,
    data_type TEXT,                    -- float, int, bool 等
    is_energy_related BOOLEAN DEFAULT false
);
```

#### 示例：电表测点绑定

| tag | asset_id | metric_name | unit |
|-----|---------|------------|------|
| `em_001.active_power` | [Meter01 ID] | active_power | kW |
| `em_001.energy_total` | [Meter01 ID] | energy_total | kWh |

---

## 三、AAS（Asset Administration Shell）映射

### 1. AAS Mapping 表结构

```sql
CREATE TABLE aas_mapping (
    aas_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    asset_id UUID NOT NULL REFERENCES asset_instance(id),
    submodel_id UUID REFERENCES asset_submodel(id),  -- 可选
    property_mapping JSONB NOT NULL,  -- AAS 属性 ↔ 本地路径
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. 示例：AAS 属性映射（以粮机为例）

假设 AAS 需要以下属性：
- `ManufacturerName` → 对应 `properties.manufacturer`
- `SerialNumber` → 对应 `properties.equipmentCode`
- `NextInspectionDate` → 对应 `submodel('maintenance').nextInspectionDate`

则 `property_mapping` 内容为：

```json
{
  "ManufacturerName": "properties.manufacturer",
  "SerialNumber": "properties.equipmentCode",
  "NextInspectionDate": "submodel('maintenance').nextInspectionDate"
}
```

> 注：平台需支持解析 `submodel(...)` 语法，从 `asset_submodel` 中提取值。

### 3. 插件 YAML 中声明 AAS 映射（可选）

```yaml
# battery_stack.type.yaml
fields:
  - name: manufacturer
    label: 制造商名称
    type: string
    required: true
    aasMapping: ManufacturerName

  - name: serial
    label: 序列号
    type: string
    required: true
    aasMapping: SerialNumber
```

### 4. 查询 AAS 数据（SQL 示例）

```sql
SELECT 
  ai.id AS asset_id,
  am.property_mapping,
  jsonb_object_agg(
    key, 
    CASE 
      WHEN value LIKE 'properties.%' THEN 
        ai.properties->>(substring(value from 12))
      WHEN value LIKE 'submodel(%)%' THEN 
        -- 此处需应用函数解析 submodel 引用（示意）
        (SELECT asm.properties->>(...) FROM asset_submodel asm WHERE ...)
    END
  ) AS aas_properties
FROM asset_instance ai
JOIN aas_mapping am ON ai.id = am.asset_id
CROSS JOIN jsonb_each_text(am.property_mapping)
GROUP BY ai.id, am.property_mapping;
```

> 实际实现中建议封装为视图或服务层逻辑。

---

## 四、多维统计能力支撑（查询示例）

### 场景 1：统计“DryingWorkshop 所有设备月度总用电”

```sql
SELECT SUM(m.value) AS total_kwh
FROM measurement_point mp
JOIN asset_instance ai ON mp.asset_id = ai.id
JOIN timeseries_data m ON mp.tag = m.tag  -- 假设时序表
WHERE ai.location_path LIKE 'GrainPlant/DryingWorkshop/%'
  AND mp.metric_name = 'energy_total'
  AND m.time >= '2026-01-01'
  AND m.time < '2026-02-01';
```

### 场景 2：列出“所有超期未巡检的粮机”

```sql
SELECT ai.name, ai.properties->>'equipmentCode'
FROM asset_instance ai
JOIN asset_submodel asm ON ai.id = asm.asset_id AND asm.submodel_name = 'maintenance'
WHERE ai.asset_type_id = (SELECT id FROM asset_type WHERE key = 'grain_machinery')
  AND (asm.properties->>'nextInspectionDate')::DATE < CURRENT_DATE;
```

### 场景 3：按“工艺阶段”汇总设备数量

```sql
SELECT 
  properties->>'processStage' AS stage,
  COUNT(*) AS device_count
FROM asset_instance ai
JOIN asset_type at ON ai.asset_type_id = at.id
WHERE at.key = 'grain_machinery'
GROUP BY properties->>'processStage';
```

---

## 五、行业插件工作全流程（以粮机为例）

1. **插件注册**  
   - 上传 `grain-machinery-plugin.zip`  
   - 平台解析 `asset_types/grain_machinery.type.yaml`  
   - 写入 `asset_type` 表

2. **创建设备**  
   - 用户选择“粮食加工设备”  
   - 表单动态生成（基于 `schema_json`）  
   - 提交后写入 `asset_instance.properties`

3. **绑定业务**  
   - 自动创建 `maintenance` 子模型（若配置）  
   - 自动关联巡检项模板（基于 `asset_type_key`）  
   - 手动绑定测点 → 写入 `measurement_point`

4. **运行时使用**  
   - 规则引擎读取 `properties` 和 `submodel`  
   - 看板按 `location_path` 聚合数据  
   - API 返回 AAS 兼容格式（通过 `aas_mapping` 动态代理）

---

## 六、总结：统一底座如何支撑复杂工业场景

| 需求 | 实现方式 |
|------|--------|
| **多维拓扑** | `location_path`（树） + 自定义关系表（网） |
| **行业字段** | `asset_instance.properties`（JSONB） |
| **维保巡检** | `asset_submodel` + `inspection_item_template` |
| **备件管理** | 独立备件表 + 设备-备件关联 |
| **数据统计** | 利用 `location_path` 和 `properties` 进行多维 GROUP BY |
| **AAS 兼容** | `aas_mapping` 表 + 动态代理 |

> ✅ **所有能力均建立在统一资产底座之上，无需为每个行业重建数据模型。**

---

## 七、附录：核心设计原则回顾

- **设备 = `asset_instance`**  
- **设备类型 = `asset_type`（由插件定义）**  
- **关系拓扑 = `location_path`（树形路径） + 自定义关系表（网状）**  
- **业务扩展 = `asset_submodel`（维保、巡检等）**  
- **静态属性 = `properties`（JSONB）**  
- **动态测点 = `measurement_point`**

> 架构基于 PostgreSQL + JSONB + SCADA，保持与 AAS 兼容。

---

如需以下配套内容，请告知：
- 完整 DDL 脚本（含索引与约束）
- 粮机/电表插件 YAML 完整示例包
- Power BI / Grafana 多维看板查询模板
- AAS 接口 Mock 与 OpenAPI 规范

--- 

> 此备忘录可作为开发规范、架构文档、售前材料或内部培训资料使用。